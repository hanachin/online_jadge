// Generated by CoffeeScript 1.6.2
var AC_TMP, TABLE_TMP, WA_TMP, get_question;

TABLE_TMP = '<table class="table table-bordered" style="padding: 20px; width: 1030px; margin: auto; margin-top: 15px;">\n  <tbody id="list">\n    <tr style="background-color: #E8E8E8;">\n      <td>問題名</td>\n      <td>解答状況</td>\n      <td>解答回数</td>\n    </tr>\n  </tbody>\n</table>';

AC_TMP = '<img src="images/ac.png" alt="ac" style="height: 30%;">\n<span style="margin-left: 1em;">正解</span>';

WA_TMP = '<img src="images/wa.png" alt="wa" style="height: 30%;">\n<span style="margin-left: 1em;">未提出</span>';

$(function() {
  var c, cookies, parse, _i, _len;

  if (document.cookie.length !== '') {
    cookies = document.cookie.split(';');
    for (_i = 0, _len = cookies.length; _i < _len; _i++) {
      c = cookies[_i];
      parse = c.split('=');
      cookies[parse[0]] = decodeURIComponent(parse[1]);
    }
    get_question(cookies['gradeNo'], cookies[' lessonNo']);
  }
  return $('select').change(function() {
    var gradeNo, lessonNo;

    gradeNo = $('#gradeNo option:selected').val();
    lessonNo = $('#lessonNo option:selected').val();
    return get_question(gradeNo, lessonNo);
  });
});

get_question = function(gradeNo, lessonNo) {
  var loadingIcon;

  if (gradeNo !== 'null' && lessonNo !== 'null') {
    loadingIcon = "<div id='loadingIcon' style='text-align: center; width: 100%;'></div>";
    $('#questions').html(loadingIcon);
    $('#loadingIcon').append(loadImg.canvas);
    return $.ajax({
      url: "/get_questions",
      type: "get",
      data: {
        gradeNo: gradeNo,
        lessonNo: lessonNo
      },
      dataType: 'text'
    }).done(function(data) {
      var content, correcters, obj, progress, resJSON, state, _i, _len;

      document.cookie = "gradeNo=" + gradeNo + ";";
      document.cookie = "lessonNo=" + lessonNo + ";";
      resJSON = $.parseJSON(data);
      $('#questions').html(TABLE_TMP);
      for (_i = 0, _len = resJSON.length; _i < _len; _i++) {
        obj = resJSON[_i];
        correcters = obj.correcters;
        progress = parseInt(correcters / 43 * 100, 10);
        if (obj.state === 'AC') {
          state = AC_TMP;
        } else {
          state = WA_TMP;
        }
        content = "<tr data-href=\"/coding?questionNo=" + obj.questionNo + "\" class=\"clickable\">\n  <td>\n    <a href=\"/coding?questionNo=" + obj.questionNo + "\">" + obj.questionNo + "</a>\n  </td>\n  <td>" + state + "</td>\n  <td>\n    <div class=\"progress\" style=\"width:80%\">\n      <div class=\"bar\" style=\"color:black; width:" + progress + "%;\"></div>\n    </div>\n    <span>クラスの正答者：" + correcters + "/43 人</span>\n  </td>\n</tr>";
        $('#list').append(content);
      }
      return $('tr[data-href]').addClass('clickable').click(function(e) {
        if (!$(e.target).is('a')) {
          return window.location = $(e.target).closest('tr').data('href');
        }
      });
    }).fail(function() {
      return alert('サーバ通信エラー');
    });
  }
};
