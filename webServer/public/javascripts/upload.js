// Generated by CoffeeScript 1.6.2
$(function() {
  var uploadButton;

  uploadButton = $('<button/>').addClass('btn').text('アップロード').on('click', function() {
    var $this, data;

    $this = $(this);
    data = $this.data();
    $this.off('click').text('アップロードを中断する...').on('click', function() {
      $this.remove();
      return data.abort();
    });
    return data.submit().always(function() {
      $this.remove();
      return $this.text('アップロードを中断しました');
    });
  });
  return $('#fileupload').fileupload({
    url: '/upload_questions',
    dataType: 'json',
    autoUpload: false,
    acceptFileTypes: /(.xml|.csv)$/i,
    maxFileSize: 5000000,
    loadImageMaxFileSize: 15000000
  }).on('fileuploadadd', function(e, data) {
    data.context = $('#files');
    return $.each(data.files, function(index, file) {
      var node;

      node = $('<div/>').append($('<p/>').text(file.name));
      if (!index) {
        node.append('<p/>').append(uploadButton.clone(true).data(data));
        return node.appendTo(data.context);
      }
    });
  }).on('fileuploadprocessalways', function(e, data) {
    var file, index, node;

    index = data.index;
    file = data.files[index];
    node = $(data.context.children()[index]);
    if (file.error) {
      node.append('</p>');
      node.append(file.error);
    }
    if (index + 1 === data.files.length) {
      return data.context.find('button').text('Upload').prop('disabled', !!data.files.error);
    }
  }).on('fileuploadprogressall', function(e, data) {
    var progress;

    progress = parseInt(data.loaded / data.total * 100, 10);
    return $('#progress .bar').css('width', "" + progress + "%");
  }).on('fileuploaddone', function(e, data) {
    var timer_id;

    $.each(data.result.files, function(index, file) {
      var link;

      link = $('<p/>').text("" + file.filename + " ファイルのアップロードが完了しました");
      return $(data.context.children()[index]).wrap(link);
    });
    return timer_id = setTimeout(function() {
      return $('#progress .bar').css('width', "" + 0 + "%");
    }, 1000);
  }).on('fileuploadfail', function(e, data) {
    return $.each(data.result.files, function(index, file) {
      var error;

      error = $('<p/>').text("" + file.error + " >> " + file.filename + " ファイルのアップロードに失敗しました");
      return $(data.context.children()[index]).wrap(error);
    });
  });
});
