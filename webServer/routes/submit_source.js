// Generated by CoffeeScript 1.4.0
var insertQueue, requestJudgeServer, resJudgeResult, serverTable;

exports.main = function(req, res, dataBase) {
  var async, http, ip_address, questionNo, source, submitQueueTable, username;
  async = require('async');
  http = require('http');
  username = req.session.username;
  questionNo = req.body.questionNo;
  source = req.body.source;
  ip_address = req.ip;
  submitQueueTable = dataBase.submitQueueTable;
  async.series([
    function(callBack) {
      return insertQueue(username, questionNo, source, submitQueueTable, callBack);
    }, function(callBack) {
      return callBack(null, 2);
    }, function(callBack) {
      return requestJudgeServer(req, http.get, callBack);
    }, function(callBack) {
      return resJudgeResult(req, res, callBack);
    }
  ], function(err, result) {
    if (err) {
      throw err;
      res.redirect('/');
    }
    return console.log("requestJudgeServer all done. " + result);
  });
  return console.log("requestJudgeServer ---------- " + ip_address);
};

insertQueue = function(username, questionNo, source, submitQueueTable, callBack) {
  var insert_obj, saveData;
  insert_obj = {
    userID: username,
    questionNo: questionNo,
    source: source
  };
  saveData = submitQueueTable.build(insert_obj);
  return saveData.save().success(function() {
    console.log('submitQueueTable save success');
    return callBack(null, 1);
  }).error(function(error) {
    return console.log("submitQueueTable save Error >> " + error);
  });
};

/*
httpリクエスト投げすぎるとsocket hung up ?というエラーが起きるのでひとまずコメントアウト
checkJudgeServer = (req, reqHttp, callBack, judgeServerID) ->
  # チェックした結果すべてのジャッジサーバが作業中の場合、１秒待ったあとに再度この関数を実行する
  cpu_num = require('os').cpus().length
  if (judgeServerID > 3001 + cpu_num - 1)
    setTimeout(checkJudgeServer, 1000, req, reqHttp, callBack, 0)
    return

  # リクエスト先の設定
  options = {
    hostname : 'localhost'
    port     : "#{3001 + judgeServerID}"
    path     : '/check_judge'
  }

  # httpリクエストを送信する
  # checkの結果 -> true：callBack関数を実行し、実際にジャッジを頼むリクエストを発行する
  #             -> false：他のジャッジサーバが空いていないかチェックする
  requestCheck = reqHttp(options,  (res) ->
    console.log "StatusCode : #{res.statusCode}"
    res.on('data', (check_result) ->
      console.log "JudgeServer #{judgeServerID} check Response:  #{res}"
      if (check_result is true)
        req.judgeServerID = judgeServerID
        callBack(null, 2)
        return
      else
        checkJudgeServer(req, reqHttp, callBack, judgeServerID + 1)
    )
  ).on('error', (error) ->
    console.log "check err #{error}"
  )
*/


serverTable = [false, false];

requestJudgeServer = function(req, reqHttp, callBack) {
  var i, options, requestJudge;
  i = 0;
  while (i < serverTable.length) {
    if (serverTable[i] === false) {
      serverTable[i] = true;
      options = {
        hostname: 'localhost',
        port: 3001 + i,
        path: '/request_judge'
      };
      requestJudge = reqHttp(options, function(res) {
        serverTable[i] = false;
        console.log("request Server " + (3001 + i));
        console.log("StatusCode : " + res.statusCode);
        res.setEncoding('utf8');
        return res.on('data', function(judge_result) {
          console.log("JudgeServer Response:  " + judge_result);
          req.result = judge_result;
          callBack(null, 2);
        }).on('error', function(error) {
          return console.log("problem with request : " + error);
        });
      });
      return;
    }
    i++;
  }
  return setTimeout(requestJudgeServer, 1000, req, reqHttp, callBack);
};

resJudgeResult = function(req, res, callBack) {
  res.json(req.result);
  return callBack(null, 3);
};
